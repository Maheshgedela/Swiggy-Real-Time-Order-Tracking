<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Order Tracking</title>

    <style>
        body {
            margin: 0;
            background: linear-gradient(135deg, #ff7a29, #ff4d00);
            height: 100vh;
            font-family: Arial;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card {
            width: 420px;
            background: white;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.25);
            overflow-y: auto;
            max-height: 92vh;
        }

        .logo {
            width: 80px;
            margin: auto;
            margin-bottom: 10px;
            display: block;
        }

        #map {
            width: 100%;
            height: 250px;
            border-radius: 15px;
            margin-top: 15px;
            border: 2px solid #ff4d00;
        }

        .eta {
            margin-top: 10px;
            text-align: center;
            background: #fff3e0;
            padding: 10px;
            border-radius: 10px;
            font-weight: bold;
            color: #ff4d00;
        }

        .timeline {
            margin-top: 20px;
        }

        .step {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .circle {
            width: 22px; height: 22px; border-radius: 50%;
            background: #ccc; margin-right: 10px;
            transition: 0.3s;
        }

        .circle.active {
            background: #ff4d00;
            box-shadow: 0 0 10px #ff4d00;
        }

        .line {
            width: 3px; height: 25px; background: #ccc;
            margin-left: 10px; margin-bottom: 20px;
        }

        .line.active {
            background: #ff4d00;
            box-shadow: 0 0 10px #ff4d00;
        }
    </style>
</head>

<body>

<div class="card">

    <img class="logo"
         src="https://upload.wikimedia.org/wikipedia/commons/1/13/Swiggy_logo.png">

    <h2 style="text-align:center;">Order Tracking</h2>

    <p><b>Order ID:</b> <span th:text="${order.id}"></span></p>
    <p><b>Status:</b> <span id="statusText" th:text="${order.status}"></span></p>

    <!-- ETA BOX -->
    <div class="eta">ETA: <span id="etaText">Calculating...</span></div>

    <!-- MAP -->
    <div id="map"></div>

    <!-- TIMELINE -->
    <div class="timeline">
        <div class="step"><div class="circle" id="s1"></div>Order Placed</div>
        <div class="line" id="l1"></div>
        <div class="step"><div class="circle" id="s2"></div>Preparing</div>
        <div class="line" id="l2"></div>
        <div class="step"><div class="circle" id="s3"></div>Ready</div>
        <div class="line" id="l3"></div>
        <div class="step"><div class="circle" id="s4"></div>Picked Up</div>
        <div class="line" id="l4"></div>
        <div class="step"><div class="circle" id="s5"></div>On The Way</div>
        <div class="line" id="l5"></div>
        <div class="step"><div class="circle" id="s6"></div>Delivered</div>
    </div>

</div>


<!-- WEBSOCKET LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

<!-- GOOGLE MAPS -->
<script
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"
        async defer></script>

<script>

    let orderId = [[${order.id}]];
    let riderLat = [[${order.riderLat}]];
    let riderLng = [[${order.riderLng}]];
    let customerLat = [[${order.customerLat}]];
    let customerLng = [[${order.customerLng}]];

    let map, riderMarker, customerMarker, polyline;

    // Timeline activate function
    function activate(n) {
        for (let i = 1; i <= n; i++) {
            document.getElementById("s" + i).classList.add("active");
            if (i < n) document.getElementById("l" + i).classList.add("active");
        }
    }

    function updateTimeline(status) {
        if (status === "Order Placed") activate(1);
        if (status === "Preparing") activate(2);
        if (status === "Ready") activate(3);
        if (status === "PickedUp") activate(4);
        if (status === "OnTheWay") activate(5);
        if (status === "Delivered") activate(6);
    }

    // Map init
    function initMap() {
        let riderPos = {lat: riderLat, lng: riderLng};
        let customerPos = {lat: customerLat, lng: customerLng};

        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 15,
            center: riderPos
        });

        riderMarker = new google.maps.Marker({
            position: riderPos,
            map: map,
            icon: {
                url: "https://cdn-icons-png.flaticon.com/512/2983/2983780.png",
                scaledSize: new google.maps.Size(45, 45)
            }
        });

        customerMarker = new google.maps.Marker({
            position: customerPos,
            map: map,
            label: "C"
        });

        polyline = new google.maps.Polyline({
            path: [riderPos, customerPos],
            geodesic: true,
            strokeColor: "#ff4d00",
            strokeWeight: 5
        });
        polyline.setMap(map);

        updateETA();
    }

    // Smooth movement animation
    function animateMarker(marker, newLat, newLng) {
        let steps = 40;
        let delay = 25;

        let oldPos = marker.getPosition();
        let latDelta = (newLat - oldPos.lat()) / steps;
        let lngDelta = (newLng - oldPos.lng()) / steps;

        let i = 0;
        let interval = setInterval(() => {
            i++;
            marker.setPosition({
                lat: oldPos.lat() + latDelta * i,
                lng: oldPos.lng() + lngDelta * i
            });
            if (i >= steps) clearInterval(interval);
        }, delay);
    }

    // ETA calculation
    function updateETA() {
        let R = 6371;
        let dLat = (customerLat - riderLat) * Math.PI / 180;
        let dLng = (customerLng - riderLng) * Math.PI / 180;

        let a = Math.sin(dLat/2) ** 2 +
            Math.cos(riderLat * Math.PI/180) *
            Math.cos(customerLat * Math.PI/180) *
            Math.sin(dLng/2) ** 2;

        let distance = R * 2 * Math.asin(Math.sqrt(a));
        let eta = Math.ceil(distance / 0.5);

        document.getElementById("etaText").innerText = eta + " min";
    }

    // WEBSOCKET LISTENER
    let socket = new SockJS('/ws');
    let stomp = Stomp.over(socket);

    stomp.connect({}, function () {

        stomp.subscribe("/topic/order-status/" + orderId, function (msg) {

            let data = JSON.parse(msg.body);

            // status refresh
            document.getElementById("statusText").innerText = data.status;
            updateTimeline(data.status);

            // location updates
            if (data.riderLat && data.riderLng) {
                animateMarker(riderMarker, data.riderLat, data.riderLng);

                riderLat = data.riderLat;
                riderLng = data.riderLng;

                polyline.setPath([
                    {lat: riderLat, lng: riderLng},
                    {lat: customerLat, lng: customerLng}
                ]);

                updateETA();
            }
        });
    });

</script>

</body>
</html>
